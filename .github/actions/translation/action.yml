name: Add translations
description: Adds missing translations, and stops the execution if there are any updates
inputs:
  openai-key:
    description: "OpenAi key"
    required: true
  self-contained-system:
    description: "The system to translate"
    required: true
  github-pat:
    description: "Github workflow token"
    required: true

permissions:
  contents: write
  actions: write

runs:
  using: "composite"
  steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Fetch all branches to ensure the ref is available
        ref: ${{ github.head_ref }}

    - name: Setup .NET Core SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    - name: Restore .NET Dependencies
      working-directory: developer-cli
      run: dotnet restore
      shell: bash

    - name: Generate and Set User Secret for Token Signing Key
      working-directory: developer-cli
      run: |
        # Extract UserSecretsId from the .csproj file
        USER_SECRETS_ID=$(grep -oP '(?<=<UserSecretsId>).*?(?=</UserSecretsId>)' DeveloperCli.csproj)
                
        dotnet user-secrets set "OpenAIApiKey" "${{ inputs.openai-key }}" --id $USER_SECRETS_ID
      shell: bash

    - name: Run translate command
      working-directory: developer-cli
      run: |
        dotnet run --no-restore -- translate -s "${{ inputs.self-contained-system }}"
      shell: bash

    - name: Check and publish translations
      run: |
        if [[ ! `git status --porcelain` ]]; then
          echo "No missing translations are detected. Continuing execution."
          exit 0
        fi

        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"

        git add .
        git commit -m "Add translations"
        
        git remote set-url origin https://x-access-token:${PAT}@github.com/${{ github.repository }}.git
        git push origin ${{ github.head_ref }}

        # Trigger the workflow via API
        WORKFLOW_ID="${{ inputs.self-contained-system }}.yml"
        curl -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: token ${PAT}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/${WORKFLOW_ID}/dispatches \
          -d '{"ref":"${{ github.head_ref }}", "inputs":{}}'

        echo "Missing translations are added. A new workflow has been triggered."
        exit 1
      shell: bash
      env:
        PAT: ${{ inputs.github-pat }}
        GH_TOKEN: ${{ inputs.github-pat }}
